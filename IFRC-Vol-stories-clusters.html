<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.css" rel="stylesheet" />
    <link href="./clusters.css" rel="stylesheet" />
    <script src='./csv2geojson.js'></script>
    <script src="https://unpkg.com/supercluster@6.0.2/dist/supercluster.min.js"></script>
</head>


<style>
    body {
      background: #ffffff;
      margin: 0;
      padding: 0;
    }


    #map {
      border-left: 1px solid #fff;
      position: absolute;
      //margin: auto;
      width: 85%;
      height: 60%;
      top: 0;
      bottom: 0;
      z-index: -1;
    }

    #results {
      position: absolute;
      height: 40%;
      z-index: 1;
    }

    #intro {
      margin-top: 0.8em;
      padding: 0.3em;
      background-color: #FFF343;
      font-style: italic;
    }

</style>

<body>

<div id='map'></div>
<div id="results">
<div id="intro">Click on the circles above to see a list of stories for that area. Or zoom in to see the stories from specific locations.</div>
</div>
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiaWFub2QiLCJhIjoiY2s5MzBnMWVzMDBoazNsczFwNDU3MDhzdCJ9.m-pcCq-j4Y0y717DBXF_Qw';

var map = new mapboxgl.Map({
    container: 'map', // container id
    style: 'mapbox://styles/ianod/ck9a7c8lu11431ipbyvxb1pph', //stylesheet location
    center: [7.84999, 17.69575], // starting position
    zoom: 0.85 // starting zoom
});

// Add zoom and rotation controls to the map.
map.addControl(new mapboxgl.NavigationControl());

            document.getElementById('results').style.top = (document.getElementById('map').offsetHeight) + "px";

$(document).ready(function() {
    $.ajax({
        type: "GET",
        url: 'https://cors-anywhere.herokuapp.com/https://docs.google.com/spreadsheets/d/e/2PACX-1vRZrfy0aAVCUxbI37nwAI10oVZcxdm06XpU2i-Mcnc_NjDRouUO2cR5VsAUnNmE6lWabDVcovuHkJy7/pub?gid=393242394&single=true&output=csv',
        dataType: "text",
        success: function(csvData) {makeGeoJSON(csvData);}
        //success: function(csvData) {window.alert(csvData);}
     });
});

function makeGeoJSON(csvData) {
    csv2geojson.csv2geojson(csvData, {
        latfield: 'Latitude',
        lonfield: 'Longitude',
        delimiter: ','
    }, function(err, data) {
        map.on('load', function () {



            map.addSource('Stories', {
                'type': 'geojson',
                'data': data,
                'cluster': true,
                'clusterRadius': 80
            });

            map.addLayer({
                'id': 'clusters',
                'type': 'circle',
                'source': 'Stories',
                filter: ['has', 'point_count'],
                'layout': {
                    //"icon-image": "marker-15"
                },
                'paint': {
                    'circle-color': 'rgba(0,0,0,.6)',
                    'circle-radius': {
                         property: "point_count",
                         stops: [
                             [0,   10],
                             [10,  16],
                             [50,  20],
                             [100, 30]
                              ]
                     },
                    'circle-stroke-color': '#8dd3c7',
                    'circle-stroke-width': 5
                }
            });

            map.addLayer({
                id: 'cluster-count',
                type: 'symbol',
                source: 'Stories',
                filter: ['has', 'point_count'],
                layout: {
                    'text-field': '{point_count}',
                    'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                    'text-size': 12
                },
                'paint': {
                    'text-color': '#ffffff'
                }

            });


            map.addLayer({
                id: 'unclustered-point',
                type: 'circle',
                source: 'Stories',
                filter: ['!', ['has', 'point_count']],
                paint: {
                    'circle-color': 'rgba(0,0,0,.6)',
                    'circle-radius': 8,
                    'circle-stroke-width': 5,
                    'circle-stroke-color': '#8dd3c7'
                }
            });


            map.addLayer({
                id: 'unclustered-count',
                type: 'symbol',
                source: 'Stories',
                filter: ['!', ['has', 'point_count']],
                layout: {
                    'text-field': '1',
                    'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                    'text-size': 12
                },
                'paint': {
                    'text-color': '#ffffff'
                }
            });


            // from https://stackoverflow.com/questions/38651290/mapbox-get-list-of-points-by-click-on-cluster

            map.on('click',/* cluster layer id */ 'clusters', function (e) {

                var features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
                var clusterId = features[0].properties.cluster_id,
                point_count = features[0].properties.point_count,
                clusterSource = map.getSource(/* cluster layer data source id */'Stories');

                // Get all points under a cluster
                clusterSource.getClusterLeaves(clusterId, point_count, 0, function(err, aFeatures){
			buildResults(aFeatures);
                })

            });


            // click on unclustered point
            map.on('click',/* cluster layer id */ 'unclustered-point', function (e) {

                var features = map.queryRenderedFeatures(e.point, { layers: ['unclustered-point'] });
                buildResults(features);
            });


        });    
    });
}




function buildResults(features) {
	var arrayLength = features.length;
	var html_string = '<h3>Results</h3>';
	for (var i = 0; i < arrayLength; i++) {
		html_string += '<button type="button" class="collapsible"><b>'+ features[i].properties.Title + '</b>, ' + features[i].properties.NationalSociety + '</button>';
		html_string += '<div class="collapsed_content"><p><i>' + features[i].properties.Submitter + '</i> &mdash; ' + features[i].properties.Story + '</p></div>'
	}
	document.getElementById('results').innerHTML = html_string;

	var coll = document.getElementsByClassName("collapsible");
	var i;

	for (i = 0; i < coll.length; i++) {
		coll[i].addEventListener("click", function() {
			this.classList.toggle("active");
                        var content = this.nextElementSibling;
                        if (content.style.display === "block") {
                              content.style.display = "none";
                        } else {
                              content.style.display = "block";
                        }
		});
	}
}


</script>

</body>
</html>